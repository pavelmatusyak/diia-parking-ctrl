version: '3.8'

services:
  # ==========================================================================
  # Core Services
  # ==========================================================================

  api:
    build: .
    container_name: parking-violations-api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - DEBUG=true
      - ENVIRONMENT=development
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/api:/var/log/api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    container_name: parking-violations-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=parking_violations
      - POSTGRES_MAX_CONNECTIONS=100
    ports:
      - "5440:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Redis Services (Could be split into separate instances in production)
  # ==========================================================================

  redis:
    image: redis:7-alpine
    container_name: parking-violations-redis
    command: >
      redis-server
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 60 1
      --save 300 10
      --save 900 100
      --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Optional: Redis Commander for debugging
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: parking-violations-redis-commander
    environment:
      - REDIS_HOSTS=cache:redis:6379:0,broker:redis:6379:1,results:redis:6379:2
    ports:
      - "8081:8081"
    depends_on:
      - redis
    profiles:
      - debug

  # ==========================================================================
  # Celery Workers (Multiple workers for different queue priorities)
  # ==========================================================================

  # High Priority Worker - For user-facing tasks
  celery_worker_high:
    build: .
    container_name: parking-violations-celery-high-1
    command: >
      celery -A foundation.celery_app_enhanced worker
      --queues=high_priority
      --concurrency=4
      --prefetch-multiplier=1
      --max-tasks-per-child=100
      --loglevel=info
      --hostname=high@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/celery:/var/log/celery
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # Default Worker - For standard priority tasks
  celery_worker_default:
    build: .
    container_name: parking-violations-celery-default-1
    command: >
      celery -A foundation.celery_app_enhanced worker
      --queues=default
      --concurrency=2
      --prefetch-multiplier=4
      --max-tasks-per-child=500
      --loglevel=info
      --hostname=default@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/celery:/var/log/celery
    restart: unless-stopped
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # Low Priority Worker - For background tasks
  celery_worker_low:
    build: .
    container_name: parking-violations-celery-low-1
    command: >
      celery -A foundation.celery_app_enhanced worker
      --queues=low_priority,scheduled
      --concurrency=1
      --prefetch-multiplier=2
      --max-tasks-per-child=1000
      --loglevel=info
      --hostname=low@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/celery:/var/log/celery
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

  # Dead Letter Queue Worker
  celery_worker_dlq:
    build: .
    container_name: parking-violations-celery-dlq
    command: >
      celery -A foundation.celery_app_enhanced worker
      --queues=dead_letter
      --concurrency=1
      --prefetch-multiplier=1
      --max-tasks-per-child=100
      --loglevel=warning
      --hostname=dlq@%h
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/celery:/var/log/celery
    restart: unless-stopped

  # ==========================================================================
  # Celery Beat Scheduler
  # ==========================================================================

  celery_beat:
    build: .
    container_name: parking-violations-celery-beat
    command: >
      celery -A foundation.celery_app_enhanced beat
      --loglevel=info
      --pidfile=/tmp/celerybeat.pid
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/parking_violations
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    env_file:
      - .env
    depends_on:
      - db
      - redis
    volumes:
      - .:/app
      - ./logs/celery:/var/log/celery
      - celerybeat_schedule:/tmp
    restart: unless-stopped

  # ==========================================================================
  # Monitoring Services
  # ==========================================================================

  # Flower - Celery Monitoring Tool
  flower:
    build: .
    container_name: parking-violations-flower
    command: >
      celery -A foundation.celery_app_enhanced flower
      --port=5555
      --broker_api=redis://redis:6379/1
      --basic_auth=admin:admin
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - FLOWER_UNAUTHENTICATED_API=true
    depends_on:
      - redis
    restart: unless-stopped
    profiles:
      - monitoring

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: parking-violations-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped
    profiles:
      - monitoring

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: parking-violations-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    restart: unless-stopped
    profiles:
      - monitoring

  # Custom monitoring API
  monitoring_api:
    build: .
    container_name: parking-violations-monitoring
    command: python -m foundation.celery_app_enhanced
    ports:
      - "5556:5555"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - redis
    restart: unless-stopped
    profiles:
      - monitoring

# ==========================================================================
# Volumes
# ==========================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  celerybeat_schedule:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ==========================================================================
# Networks (Optional: for better isolation)
# ==========================================================================

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16